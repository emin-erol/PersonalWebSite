@model List<ResultContactMailDto>

@{
    ViewData["Title"] = "Index";
    Layout = "~/Areas/Admin/Views/UILayout/Index.cshtml";
    int count = 0;

    string ShortenMessage(string message)
    {
        if (string.IsNullOrEmpty(message)) return "";

        int dotIndex = message.IndexOf('.');
        string shortenedMessage = dotIndex > -1 ? message.Substring(0, dotIndex + 1) : message;

        if (shortenedMessage.Length > 100)
        {
            shortenedMessage = shortenedMessage.Substring(0, 100);
        }

        if (shortenedMessage.Length < message.Length)
        {
            shortenedMessage += "...";
        }

        return shortenedMessage;
    }
}

<style>
    .select-column {
        display: none;
    }

    .highlighted-row {
        background-color: #d1ecf1;
    }

    .clickable-row {
        transition: background-color 0.3s ease;
        cursor: pointer;
    }

        .clickable-row:hover {
            background-color: #f0f0f0;
        }

    .unread-mail td {
        font-weight: bold;
    }
</style>

<div class="page-content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-xl-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="card-title">Mailler</h4>
                            <div class="d-flex justify-content-end align-items-center mb-4 gap-2">
                                <div id="actionButtons" class="mx-2" style="display: none;">
                                    <button id="deleteSelected" class="btn btn-outline-danger">Sil</button>
                                    <button id="markAsReadSelected" class="btn btn-outline-success">Okundu Olarak İşaretle</button>
                                </div>
                                <button id="toggleSelect" class="btn btn-outline-primary">Seç</button>
                            </div>
                        </div>
                        <p class="card-subtitle mb-4">
                            Kullanıcılar tarafından gönderilen mail ve ilgili bilgileri inceleyebilirsiniz.
                        </p>
                        <div class="table-responsive">
                            <table class="table mb-0">
                                <thead>
                                    <tr>
                                        <th style="display: none;" class="select-column"></th>
                                        <th>#</th>
                                        <th>Ad Soyad</th>
                                        <th>Eposta</th>
                                        <th>Konu</th>
                                        <th>Mesaj</th>
                                        <th>Gönderim Tarihi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model)
                                    {
                                        count++;
                                        var isUnreadClass = item.IsRead == false ? "unread-mail" : "";
                                        <tr class="clickable-row @isUnreadClass" data-toggle="modal" data-target="#mailModal"
                                            data-id="@item.ContactMailId" data-name="@item.Name" data-email="@item.Email"
                                            data-subject="@item.Subject" data-message="@item.Message" data-date="@item.ShippingDate">
                                            <td style="display: none;" class="select-column">
                                                <input type="checkbox" class="mail-checkbox" onchange="highlightRow(this)">
                                            </td>
                                            <td>@count</td>
                                            <td>@item.Name</td>
                                            <td>@item.Email</td>
                                            <td>@item.Subject</td>
                                            <td>@ShortenMessage(item.Message!)</td>
                                            <td>@item.ShippingDate.ToString("dd.MM.yyyy")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mailModal" tabindex="-1" role="dialog" aria-labelledby="mailModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mailModalLabel">Mail Detayları</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>Ad Soyad:</strong> <span id="modalName"></span></p>
                <p><strong>Gönderim Tarihi:</strong> <span id="modalDate"></span></p>
                <p><strong>Eposta:</strong> <span id="modalEmail"></span></p>
                <p><strong>Konu:</strong> <span id="modalSubject"></span></p>
                <p><strong>Mesaj:</strong></p>
                <p id="modalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<script>
    let isSelectMode = false;

        $(document).ready(function () {
        $('#toggleSelect').click(function () {
            const selectColumns = $('.select-column');
            const checkboxes = $('.mail-checkbox');

            if (selectColumns.is(':visible')) {
                selectColumns.hide();
                checkboxes.prop('checked', false);
                $('tr').removeClass('highlighted-row');
                $(this).text('Seç');
                isSelectMode = false;
                $('#actionButtons').hide();
            } else {
                selectColumns.show();
                $(this).text('Seçimi Kapat');
                isSelectMode = true;
                $('#actionButtons').show();
            }
        });

        $('.mail-checkbox').on('change', function () {
            highlightRow(this);
        });

        $('.clickable-row').on('click', function (e) {
            if (isSelectMode) {
                const checkbox = $(this).find('.mail-checkbox');
                checkbox.prop('checked', !checkbox.prop('checked'));
                highlightRow(checkbox);
                e.stopPropagation();
            } else {
                showMailDetails(this);
            }
        });

            $('#deleteSelected').click(function () {
                const selectedMailIds = [];

                $('.mail-checkbox:checked').each(function () {
                    const mailId = $(this).closest('tr').data('id');
                    selectedMailIds.push(mailId);
                });

                if (selectedMailIds.length > 0) {
                    $.ajax({
                        url: '/Admin/ContactMail/RemoveBulk',
                        type: 'DELETE',
                        contentType: 'application/json',
                        data: JSON.stringify(selectedMailIds),
                        success: function (response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Başarılı',
                                    text: response.message,
                                    confirmButtonText: 'Tamam'
                                });

                                $('#toggleSelect').text('Seç');
                                $('.select-column').hide();
                                $('tr').removeClass('highlighted-row');
                                isSelectMode = false;
                                $('#actionButtons').hide();

                                $('.mail-checkbox:checked').each(function () {
                                    $(this).closest('tr').remove();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Hata',
                                    text: response.message,
                                    confirmButtonText: 'Tamam'
                                });
                            }
                        },
                        error: function (error) {
                            console.error('Mail silme işlemi başarısız:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Hata',
                                text: 'Silme işlemi başarısız oldu.',
                                confirmButtonText: 'Tamam'
                            });
                        }
                    });
                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Uyarı',
                        text: 'Silinecek mail seçmediniz.',
                        confirmButtonText: 'Tamam'
                    });
                }
            });

        function highlightRow(checkbox) {
            const row = $(checkbox).closest('tr');
            if ($(checkbox).is(':checked')) {
                row.addClass('highlighted-row');
            } else {
                row.removeClass('highlighted-row');
            }
        }

        function showMailDetails(element) {
            var mailId = $(element).data('id');
            var mailName = $(element).data('name');
            var mailEmail = $(element).data('email');
            var mailSubject = $(element).data('subject');
            var mailMessage = $(element).data('message');
            var mailDate = $(element).data('date');
            var isRead = $(element).hasClass('unread-mail');

            $('#modalName').text(mailName);
            $('#modalEmail').text(mailEmail);
            $('#modalSubject').text(mailSubject);
            $('#modalMessage').text(mailMessage);
            $('#modalDate').text(mailDate);

            if (!isSelectMode && isRead) {
                markMailAsRead(mailId, element);
            }
        }

        function markMailAsRead(mailId, element) {
            $.ajax({
                url: '/Admin/ContactMail/MarkMailAsRead/' + mailId,
                type: 'POST',
                success: function (response) {
                    $(element).removeClass('unread-mail');
                },
                error: function (error) {
                    console.error('Mail işaretlenemedi:', error);
                }
            });
        }
    });

</script>

